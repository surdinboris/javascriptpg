<div></div>
<script>
    // The old draw tool. Rewrite this.

    function draw(pos, state, dispatch) {
        state.prev ={}

        function drawPixel({x, y}, state) {

            function  isNeighbor(newpos, state, dispatch){
                if (state.prev.nx == undefined  || state.prev.ny == undefined)
                    return false
                if (newpos.x-state.prev.nx >= -1 && newpos.x-state.prev.nx <= 1 &&
                    newpos.y-state.prev.ny >= -1 && newpos.y-state.prev.ny <= 1)
                    return false
                else
                //console.log('need line')
                    return	line(newpos, state, dispatch)

            }

            //let prevPos = {x:state.prev.nx, y:state.prev.ny}
            let newPos = {x:x, y:y}
            let lines= isNeighbor(newPos, state, dispatch)

            let drawn =[{x, y, color: state.color}]

            if (lines)  drawn.push(...lines)
            //console.log(drawn)
            // console.log(lines)

            dispatch({picture: state.picture.draw(drawn)});

            //reassigning previous coords to state prev container
            state.prev.nx = x;
            state.prev.ny = y;
        }
        drawPixel(pos, state);
        return drawPixel;
    }

    function line(pos, state, dispatch) {
        //    The first thing your line drawing function should
        //  do is check whether the difference between the
        //  x-coordinates is larger than the difference between
        //  the y-coordinates. If it is, this is a horizontal-ish
        //  line, and if not, a vertical-ish one.
        let ydiff=Math.abs(pos.y-state.prev.ny)
        let xdiff=Math.abs(pos.x-state.prev.nx)
        console.log('y differ',ydiff)
        console.log('x differ',xdiff)
        if (ydiff>xdiff) console.log('vertical-ish')
        else console.log('horizontal-ish')
        //range building and filling gaps
        let pixline=[]
        for (let y = pos.y; y <= state.prev.ny; y++) {
            for (let x = pos.x; x <= state.prev.nx; x++) {
                pixline.push({x, y, color: "#ff3e3e"})
            }
        }
        return pixline
    }

    let dom = startPixelEditor({
        tools: {draw, line, fill, rectangle, pick}
    });
    document.querySelector("div").appendChild(dom);

</script>